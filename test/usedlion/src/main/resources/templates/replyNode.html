<!-- templates/fragments/replyNode.html -->
<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
          th:fragment="reply(node, depth, postId,userId)">
          <style>
            .reply-content {
  background-color: #f1f3f5;
  border-left: 4px solid #0d6efd;
  padding: 8px 12px;
  font-size: 14px;
  line-height: 1.4;
  border-radius: 6px;
  margin-bottom: 10px;
  margin-left: 20px;  
}
          </style>
  <div th:style="'margin-left:' + (${depth} * 40) + 'px'">

    <!-- 1) 메타 정보 (헤더) -->
    <div class="reply-header" style="margin-bottom:4px;">
      <strong>
        <a th:href="@{/user/{userId}(userId=${node.reply.userId})}"
           th:text="${node.reply.username}">작성자</a>
      </strong>
      <span th:text="${#temporals.format(node.reply.created_at,'yyyy-MM-dd HH:mm')}">날짜</span>
      <button th:if="${node.reply.email != #authentication.principal.username}" type="button"
      th:onclick="'openReportModal(' + ${node.reply.id} + ')'"
      >신고</button>
      <sec:authorize access="isAuthenticated()">
        <th:block th:if="${#authentication.principal.username == node.reply.email}">
          <button type="button"
                  th:onclick="'openEditModal(' + ${node.reply.id} + ')'"
          >수정</button>
          <button type="button"
                  th:onclick="'openDeleteModal(' + ${node.reply.id} + ')'"
          >삭제</button>
        </th:block>
      </sec:authorize>
    </div>

    <!-- 2) 댓글 본문 -->
    <div class="reply-content" style="margin-bottom:8px;">
      <p th:text="${node.reply.content}">댓글 내용</p>
    </div>

    <!-- 3) 신고 모달 -->
    <div 
    th:id="'reportModal-' + ${node.reply.id}" class="modal">
      <form th:action="@{/report/{postId}/{userId}(
                      postId=${postId},
                      userId=${node.reply.userId})}"
            method="post">
        <h3>신고 사유 입력</h3>
        <textarea name="reason" rows="4" cols="40" required></textarea><br><br>
        <button type="submit">제출</button>
        <button type="button"
                th:onclick="'closeModal(\'reportModal-' + ${node.reply.id} + '\')'">
          취소
        </button>
      </form>
    </div>

    <!-- 4) 수정 모달 -->
    <div th:id="'editModal-' + ${node.reply.id}" class="modal">
      <form th:action="@{/reply/edit/{replyId}(
                      replyId=${node.reply.id})}"
            method="post">
        <h3>댓글 수정</h3>
        <textarea name="content"
                  rows="3" cols="40"
                  th:text="${node.reply.content}"
                  required></textarea><br><br>
        <button type="submit">수정완료</button>
        <button type="button"
                th:onclick="'closeModal(\'editModal-' + ${node.reply.id} + '\')'">
          취소
        </button>
      </form>
    </div>

    <!-- 5) 삭제 모달 -->
    <div th:id="'deleteModal-' + ${node.reply.id}" class="modal">
      <p>정말 이 댓글을 삭제하시겠습니까?</p>
      <form th:action="@{/reply/delete/{replyId}(
                      replyId=${node.reply.id})}"
            method="post">
        <button type="submit">삭제</button>
        <button type="button"
                th:onclick="'closeModal(\'deleteModal-' + ${node.reply.id} + '\')'">
          취소
        </button>
      </form>
    </div>

    <!-- 6) 대댓글 입력 폼 -->
    <form th:action="@{/reply/{postId}/{parentReplyId}(
                    postId=${postId},
                    parentReplyId=${node.reply.id})}"
          method="post">
      <input type="text" name="content" placeholder="대댓글을 입력하세요" required />
      <button type="submit">답글</button>
    </form>

  </div>

  <!-- 자식 댓글 재귀 호출 -->
  <th:block th:if="${node.children}" th:each="child : ${node.children}">
    <div th:replace="~{replyNode :: reply(${child}, ${depth + 1}, ${postId},${userId})}"></div>
  </th:block>
</th:block>
